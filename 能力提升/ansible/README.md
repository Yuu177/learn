[TOC]

# ansible

## ansible 介绍

官方介绍：ansible 是新出现的自动化运维工具，基于 Python 开发，集合了众多运维工具（puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。

举个例子：我们可以理解为是一个工具，可以批量处理多台服务器的机器。举个例子，如果我要在2 台服务器都安装一个 nginx，然后配置相关代理，上传对应的静态资源。那么我们常规的操作，就是先 ssh 登录一台机子，然后手动处理完这些任务后，再登录一台机子，继续手动相关操作。通过 ansible，它会帮我们批量的操作 2 台机子。底层的原理：通过配置好的 sshkey，可以连接到配置好 host 的机器（这两台机子），然后通过相关命令，批量操作 2 台机子。

## ansible的幂等性

介绍 ansible 特点时说过，ansible 具有幂等性，幂等性能够保证我们重复的执行一项操作时，得到的结果是相同的，下面详细介绍一下幂等性的概念。

举个例子，你想把一个文件拷贝到目标主机的某个目录上，但是你不确定此目录中是否已经存在此文件，当你使用 ansible 完成这项任务时，就非常简单了，因为如果目标主机的对应目录中已经存在此文件，那么 ansible 则不会进行任何操作，如果目标主机的对应目录中并不存在此文件，ansible 就会将文件拷贝到对应目录中。说白了，ansible 是”以结果为导向的”，我们指定了一个”目标状态”，ansible 会自动判断，”当前状态”是否与”目标状态”一致，如果一致，则不进行任何操作，如果不一致，那么就将”当前状态”变成”目标状态”，这就是”幂等性”，”幂等性”可以保证我们重复的执行同一项操作时，得到的结果是一样的。

这种特性在很多场景中对于脚本来说都有一定的优势。

## ansible 任务执行

Ansible 系统由控制主机对被管节点的操作方式可分为两类，即 ad-hoc 和 playbook。

- ad-hoc 模式(点对点模式)

  使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。**就相当于在 shell 中输入一行命令。**

  - 如 `ansible 172.25.63.5 -m ping`，ansible 后面接的是 hosts，-m 后面是模块名。

- playbook 模式(剧本模式)

  是 Ansible 主要管理方式，也是 Ansible 功能强大的关键所在。**playbook 通过多个 task 集合完成一类功能**，如 Web 服务的安装部署、数据库服务器的批量备份等。可以简单地把 playbook 理解为通过组合多条 ad-hoc 操作的配置文件。**就相当于 shell 脚步。**

### 操作命令

ansible 中关于模块的命令

- 列出 ansible 所支持的模块：

`ansible-doc -l`

- 查看模块的详细帮助信息，比如 fetch：

`ansible-doc -s fetch`

- 调用模块，比如调用 ping 模块：

`ansible all -m ping`

- 调用模块的同时传入相关参数，以 fetch 为例：

`ansible testA -m fetch -a "src=/etc/fstab dest=/testdir/ansible"`

ps：ansible 后面紧跟的是 hosts。
