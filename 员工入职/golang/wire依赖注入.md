[TOC]

# wire 依赖注入

## 代码实战

- main.go

```go
package main

import (
	"context"
	"fmt"
	"io/ioutil"

	"github.com/go-redis/redis/v8"
	"gopkg.in/yaml.v2"
)

// ================== redis config ================== //
type RedisConfig struct {
	Addr     string `json:"addr,omitempty"`
	Password string `json:"password,omitempty"`
	DB       int    `json:"db,omitempty"`
}

func GetRedisConfig() RedisConfig {
	var conf RedisConfig
	yamlFile, err := ioutil.ReadFile("redis_conf.yaml")
	if err != nil {
		panic(err)
	}
	err = yaml.Unmarshal(yamlFile, &conf)
	if err != nil {
		panic(err)
	}
	return conf
}

// ================== redis client ================== //
func NewRedisClient(reidsCore *redis.Client) DataSource {
	return &redisClient{rdb: reidsCore}
}

type redisClient struct {
	rdb *redis.Client
}

func (c *redisClient) GetById(id string) string {
	return c.rdb.Get(context.Background(), id).String()
}

// ================== DataSource ================== //
type DataSource interface {
	GetById(id string) string
}

// ================== App ================== //
func NewApp(ds DataSource) *App {
	return &App{ds: ds}
}

type App struct {
	ds DataSource
}

func (a *App) Run() {
	result := a.ds.GetById("xiaobai")
	fmt.Printf("result: %v\n", result)
}

// ================== go redis ================== //
func NewRedisCore(conf RedisConfig) *redis.Client {
	return redis.NewClient(&redis.Options{
		Addr:     conf.Addr,
		Password: conf.Password,
		DB:       conf.DB,
	})
}

// 手动创建对象并依赖注入
func initApp() *App {
	conf := GetRedisConfig()
	core := NewRedisCore(conf)
	redisClient := NewRedisClient(core)
	app := NewApp(redisClient)
	return app
}

func main() {
	app := initApp()
	app.Run()
}

```

- wire.go

```go
//go:build wireinject
// +build wireinject

package main

import "github.com/google/wire"

func InitApp() *App {
	panic(wire.Build(GetRedisConfig, NewRedisCore, NewRedisClient, NewApp))
}

```

执行 wire 命令，生成 wire_gen.go 文件

- wire_gen.go

```go
// Code generated by Wire. DO NOT EDIT.

//go:generate go run github.com/google/wire/cmd/wire
//go:build !wireinject
// +build !wireinject

package main

// Injectors from wire.go:

func InitApp() *App {
	redisConfig := GetRedisConfig()
	client := NewRedisCore(redisConfig)
	dataSource := NewRedisClient(client)
	app := NewApp(dataSource)
	return app
}

```

## 参考链接

- Go 工程化 - wire 的使用 - Go语言进阶的文章 - 知乎 https://zhuanlan.zhihu.com/p/399101012
- [Go工程化(三) 依赖注入框架 wire](https://lailin.xyz/post/go-training-week4-wire.html)